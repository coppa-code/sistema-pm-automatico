# .github/workflows/birthday-check.yml
name: üéÇ Sistema de Anivers√°rios PM - Verifica√ß√£o Autom√°tica

on:
  schedule:
    # Executa todo dia √†s 9h (hor√°rio UTC = 6h Bras√≠lia)
    - cron: '0 12 * * *'  # 12h UTC = 9h Bras√≠lia
  
  # Permite execu√ß√£o manual
  workflow_dispatch:
  
  # Para testes, executa a cada push
  push:
    branches: [ main ]
    paths: [ 'scripts/**' ]

jobs:
  verificar-aniversarios:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout do c√≥digo
      uses: actions/checkout@v4
    
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: üì¶ Instalar depend√™ncias
      run: npm install
    
    - name: üéñÔ∏è Executar verifica√ß√£o PM
      env:
        # Vari√°veis de ambiente seguras (configurar no GitHub)
        FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
        TWILIO_TO_NUMBER: ${{ secrets.TWILIO_TO_NUMBER }}
        NOTIFICATION_TIMING: ${{ secrets.NOTIFICATION_TIMING }}
        NOTIFICATION_TIME: ${{ secrets.NOTIFICATION_TIME }}
      run: node scripts/check-birthdays.js
    
    - name: üìã Salvar logs da execu√ß√£o
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: execution-logs-${{ github.run_number }}
        path: logs/
        retention-days: 30
    
    - name: üì± Notificar resultado via Webhook (opcional)
      if: failure()
      run: |
        curl -X POST "${{ secrets.WEBHOOK_URL }}" \
        -H "Content-Type: application/json" \
        -d '{"text":"‚ùå Falha na verifica√ß√£o de anivers√°rios PM - Run #${{ github.run_number }}"}'
