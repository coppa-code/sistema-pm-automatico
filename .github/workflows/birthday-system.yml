
# .github/workflows/birthday-system.yml
name: ğŸ‚ Sistema AniversÃ¡rios PM - AutomÃ¡tico

on:
  # Executa a cada hora
  schedule:
    - cron: '0 * * * *'  # Todo inÃ­cio de hora
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modo de teste (true/false)'
        required: false
        default: 'false'
      force_send:
        description: 'ForÃ§ar envio (true/false)'
        required: false
        default: 'false'

  # Executa em push na main
  push:
    branches: [ main ]
    paths: 
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  birthday-check:
    name: ğŸ” Verificar AniversÃ¡rios PM
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        cd scripts
        npm install
        
    - name: â° Verificar horÃ¡rio brasileiro
      run: |
        echo "ğŸ‡§ğŸ‡· HorÃ¡rio do Brasil:"
        TZ=America/Sao_Paulo date
        echo "ğŸŒ HorÃ¡rio UTC:"
        date
        
    - name: ğŸ” Executar verificaÃ§Ã£o automÃ¡tica
      env:
        FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
        TWILIO_TO_NUMBER: ${{ secrets.TWILIO_TO_NUMBER }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        FORCE_SEND: ${{ github.event.inputs.force_send || 'false' }}
      run: |
        cd scripts
        echo "ğŸ–ï¸ Iniciando verificaÃ§Ã£o PM..."
        node birthday-checker.js
        
    - name: ğŸ“Š Gerar relatÃ³rio
      if: always()
      run: |
        cd scripts
        node generate-report.js
        
    - name: ğŸ“¤ Commit logs (se houver mudanÃ§as)
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action PM"
        
        if [ -f "logs/execution-$(date +%Y-%m-%d).log" ]; then
          git add logs/
          git commit -m "ğŸ“Š Log automÃ¡tico PM - $(TZ=America/Sao_Paulo date)" || exit 0
          git push
        fi

  daily-report:
    name: ğŸ“Š RelatÃ³rio DiÃ¡rio PM
    runs-on: ubuntu-latest
    # Executa apenas Ã s 8:00 BR (11:00 UTC)
    if: github.event.schedule == '0 11 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        cd scripts
        npm install
        
    - name: ğŸ“Š Gerar relatÃ³rio diÃ¡rio
      env:
        FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
        TWILIO_TO_NUMBER: ${{ secrets.TWILIO_TO_NUMBER }}
      run: |
        cd scripts
        echo "ğŸ“Š Gerando relatÃ³rio diÃ¡rio PM..."
        node daily-report.js

  health-check:
    name: ğŸ¥ Health Check Sistema
    runs-on: ubuntu-latest
    # Executa a cada 4 horas
    if: github.event.schedule == '0 */4 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        cd scripts
        npm install
        
    - name: ğŸ¥ Verificar saÃºde do sistema
      env:
        FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
        TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
        TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
        TWILIO_TO_NUMBER: ${{ secrets.TWILIO_TO_NUMBER }}
      run: |
        cd scripts
        echo "ğŸ¥ Verificando saÃºde do sistema..."
        node health-check.js
